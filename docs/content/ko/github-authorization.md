# GitHub 인증

## 범위

Claustrum의 GitHub 인증은 작업 공간 범위 및 프로젝트 지향적입니다.

- 하나의 작업공간은 하나의 GitHub App 설치(기본 모델)를 연결합니다.
- Repo 메타데이터는 작업공간-로컬 캐시에 동기화됩니다.
- 프로젝트 역할은 GitHub 권한에서 파생됩니다.

## 작업공간 수준 GitHub 앱 설치

흐름:

1. 작업 공간에 GitHub 앱을 연결합니다.
2. 설치 메타데이터를 저장합니다.
3. 저장소를 `github_repo_links`으로 동기화합니다.
4. 저장소를 Claustrum 프로젝트에 연결합니다.

## Repo -> 프로젝트 자동 생성

Claustrum은 저장소 기반 프로젝트 프로비저닝을 지원합니다.

- 기본 저장소 키 형식: `github:owner/repo`
- 공유 모드: repo 수준 프로젝트만 사용합니다.
- 분할 모드: 선택적 하위 프로젝트 확장 정책.

## 권한 계산

프로젝트 수준 GitHub 권한은 다음과 같이 계산됩니다.

```text
final_perm = max(direct_collaborator_perm, team_derived_perm)
```
허가 순서:

```text
admin > maintain > write > triage > read
```
## 팀 매핑

팀 관계는 다음을 통해 통합됩니다.

- 저장소 -> 팀
- 팀 -> 구성원
- 회원 -> Claustrum 사용자 링크

Claustrum은 구성 가능한 역할 매핑을 통해 GitHub 권한에서 프로젝트 역할을 확인합니다.

## Webhooks를 통한 부분 재계산

웹훅 처리 대상은 리포지토리에만 영향을 미쳤습니다.

- `installation_repositories`: 변경된 저장소를 동기화하고 변경된 범위를 다시 계산합니다.
- `team` / `membership`: 팀의 영향을 받은 저장소를 다시 계산합니다.
- `repository` 이름 바꾸기: 메타데이터 새로 고침; 권한 재계산은 선택 사항입니다.
- `team_add` / `team_remove`: 영향을 받은 캐시를 무효화하고 영향을 받은 저장소를 다시 계산합니다.

## 캐시 전략

Claustrum은 성능을 위해 GitHub 그래프 조각을 캐시합니다.

- `github_repo_teams_cache`
- `github_team_members_cache`
- `github_permission_cache`

규칙:

- 일반 읽기에는 TTL을 사용합니다.
- 웹훅 업데이트 시 이벤트 범위로 무효화됩니다.
- 다시 계산할 때 권한 캐시를 덮어쓰거나 다시 작성합니다.

## 동기화 모드

| 모드 | 행동 |
|---|---|
| `add_only` | 역할을 추가/업그레이드합니다. 오래된 액세스 권한을 제거하지 않습니다. |
| `add_and_remove` | 보호 규칙을 유지하면서 GitHub와 일치하도록 역할을 추가, 업그레이드 또는 제거합니다. |

## 운영 팁

### 대규모 조직 및 속도 제한

- 가능하면 전체 재계산 대신 부분 재계산을 사용합니다.
- 이벤트 볼륨에 맞춰 조정된 캐시 TTL을 사용합니다.
- 저장소 하위 집합을 통한 일괄 수동 동기화.

### 권한 디버깅 체크리스트

1. 설치가 대상 워크스페이스에 연결되었는지 확인합니다.
2. 저장소가 프로젝트에 동기화되고 연결되었는지 확인하세요.
3. Claustrum 사용자에 대한 GitHub 사용자 링크가 있는지 확인합니다.
4. 직접/팀 최대 결과에 대한 권한 미리보기를 검사합니다.
5. 웹훅 전달 상태를 검사하고 감사 로그를 다시 계산합니다.
